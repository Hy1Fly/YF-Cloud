<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YF-Cloud Releases and Issues</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            margin: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .section {
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }
        .search-box {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .search-box input {
            width: 300px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .release, .issue {
            background-color: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .release-name, .issue-title {
            font-size: 1.5em;
            margin-bottom: 5px;
            color: #007acc;
            cursor: pointer;
        }
        .release-name:hover, .issue-title:hover {
            text-decoration: underline;
        }
        .tag {
            color: grey;
            margin-bottom: 10px;
        }
        .assets, .comments {
            list-style-type: none;
            padding-left: 0;
        }
        .assets li, .comments li {
            margin: 5px 0;
        }
        .assets a, .comments a {
            text-decoration: none;
            color: #007acc;
        }
        .assets a:hover, .comments a:hover {
            text-decoration: underline;
        }
        .issue-body, .comment-body {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .comment {
            margin-top: 10px;
            padding-left: 20px;
        }
        .author {
            display: flex;
            align-items: center;
            color: grey;
        }
        .author img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
        }
        /* 新增授权栏样式 */
        .auth-bar {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            background: #fff;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        #userInfo {
            display: none;
            align-items: center;
            gap: 10px;
        }
        #loginBtn {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .comment-form button {
            background: #007acc;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 新增授权栏 -->
    <div class="auth-bar">
        <div id="userInfo">
            <img id="userAvatar" width="30" height="30" style="border-radius: 50%;">
            <span id="userName"></span>
            <button onclick="logout()">Logout</button>
        </div>
        <button id="loginBtn" onclick="login()">Login with GitHub</button>
    </div>

    <div class="section">
        <h1 class="section-title">Welcome to YF-Cloud!</h1>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by tags or release name..." oninput="filterReleases()">
        </div>
        <div id="releases"></div>
    </div>
    <div class="section">
        <h1 class="section-title">Issues Discussion</h1>
        <div id="issues"></div>
    </div>
    <script>
        // ================= 授权相关逻辑 =================
        let accessToken = sessionStorage.getItem('gh_token');
        const CLIENT_ID = 'Ov23li7QMAWafeTcd3D9'; // 你的Client ID
        const REDIRECT_URI = 'https://hy1fly.github.io/YF-Cloud/'; // 你的回调地址

        // 登录跳转
        async function login() {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            window.location.href = authUrl;
        }

        // 处理回调
        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            
            if (code) {
                try {
                    const tokenResponse = await fetch(`https://hy1fly.github.io/YF-Cloud/auth?code=${code}`);
                    const tokenData = await tokenResponse.json();
                    
                    if (tokenData.access_token) {
                        accessToken = tokenData.access_token;
                        sessionStorage.setItem('gh_token', accessToken);
                        window.history.replaceState({}, document.title, window.location.pathname);
                        loadUserInfo();
                    }
                } catch (error) {
                    console.error('Auth error:', error);
                }
            }
        }

        // 加载用户信息
        async function loadUserInfo() {
            if (!accessToken) return;
            
            try {
                const user = await fetch('https://api.github.com/user', {
                    headers: { Authorization: `token ${accessToken}` }
                }).then(r => r.json());

                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userAvatar').src = user.avatar_url;
                document.getElementById('userName').textContent = user.login;
            } catch (error) {
                console.error('Failed to load user:', error);
            }
        }

        // 登出
        function logout() {
            sessionStorage.removeItem('gh_token');
            location.reload();
        }

        // ================= 评论功能增强 =================
        async function fetchIssues() {
            const issuesResponse = await fetch('https://api.github.com/repos/Hy1Fly/YF-Cloud/issues');
            const issues = await issuesResponse.json();
            const issuesContainer = document.getElementById('issues');
            
            for (const issue of issues) {
                const issueDiv = document.createElement('div');
                issueDiv.className = 'issue';

                const issueTitle = document.createElement('div');
                issueTitle.className = 'issue-title';
                issueTitle.textContent = issue.title;
                issueTitle.onclick = () => toggleComments(issueDiv, issue.number);

                const issueBody = document.createElement('div');
                issueBody.className = 'issue-body';
                issueBody.textContent = issue.body;

                const issueAuthor = document.createElement('div');
                issueAuthor.className = 'author';
                const authorImg = document.createElement('img');
                authorImg.src = issue.user.avatar_url;
                issueAuthor.appendChild(authorImg);
                issueAuthor.appendChild(document.createTextNode(`Author: ${issue.user.login}`));

                issueDiv.appendChild(issueTitle);
                issueDiv.appendChild(issueAuthor);
                issueDiv.appendChild(issueBody);
                issuesContainer.appendChild(issueDiv);

                const commentsList = document.createElement('div');
                commentsList.className = 'comments';
                commentsList.style.display = 'none';
                issueDiv.appendChild(commentsList);

                if (issue.comments > 0) {
                    await fetchComments(issue.number, commentsList);
                }

                // 添加评论表单
                if (accessToken) {
                    const commentForm = document.createElement('div');
                    commentForm.className = 'comment-form';
                    commentForm.innerHTML = `
                        <textarea 
                            id="commentInput-${issue.number}" 
                            placeholder="Write a comment..." 
                            style="margin-top:15px;"
                        ></textarea>
                        <button onclick="postComment(${issue.number})">Post Comment</button>
                    `;
                    commentsList.appendChild(commentForm);
                }
            }
        }

        // 提交评论
        async function postComment(issueNumber) {
            const commentText = document.getElementById(`commentInput-${issueNumber}`).value;
            if (!commentText.trim()) {
                alert('Please enter a comment.');
                return;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/Hy1Fly/YF-Cloud/issues/${issueNumber}/comments`,
                    {
                        method: 'POST',
                        headers: {
                            Authorization: `token ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ body: commentText })
                    }
                );

                if (response.ok) {
                    // 清空输入框并刷新评论
                    document.getElementById(`commentInput-${issueNumber}`).value = '';
                    alert('Comment posted successfully!');
                    location.reload(); // 刷新页面以显示新评论
                } else {
                    alert('Error posting comment: ' + (await response.text()));
                }
            } catch (error) {
                console.error('Comment error:', error);
                alert('Failed to post comment.');
            }
        }

        // 初始化处理
        handleCallback();
        fetchReleases();
        fetchIssues();
    </script>
</body>
</html>